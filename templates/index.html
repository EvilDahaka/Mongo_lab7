<!DOCTYPE html>
<html lang="uk">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Blog System</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <style>
        .navbar { margin-bottom: 2rem; }
        .post-card { margin-bottom: 1.5rem; transition: transform 0.2s; }
        .post-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tag-badge { margin: 0.2rem; }
        #auth-section { display: none; }
        .comment { border-left: 3px solid #007bff; padding-left: 1rem; margin: 1rem 0; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">üìù Blog System</a>
                <button class="navbar-toggler" type="button"
                    data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#"
                                onclick="showPosts()">–ü–æ—Å—Ç–∏</a></li>
                        <li class="nav-item"><a class="nav-link" href="#"
                                onclick="showCategories()">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</a></li>
                        <li class="nav-item"><a class="nav-link" href="#"
                                onclick="showStats()">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
                        <li class="nav-item" id="login-btn"><a class="nav-link"
                                href="#"
                                onclick="showAuth('login')">–í—Ö—ñ–¥</a></li>
                        <li class="nav-item" id="register-btn"><a
                                class="nav-link" href="#"
                                onclick="showAuth('register')">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a></li>
                        <li class="nav-item" id="user-info"
                            style="display:none;">
                            <span class="navbar-text me-3"
                                id="username-display"></span>
                            <button class="btn btn-sm btn-outline-light"
                                onclick="logout()">–í–∏–π—Ç–∏</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- Auth Section -->
            <div id="auth-section" class="row justify-content-center mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title" id="auth-title">–í—Ö—ñ–¥</h3>
                            <form id="auth-form">
                                <div class="mb-3" id="username-field"
                                    style="display:none;">
                                    <label class="form-label">–Ü–º'—è
                                        –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
                                    <input type="text" class="form-control"
                                        id="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control"
                                        id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control"
                                        id="password" required>
                                </div>
                                <button type="submit"
                                    class="btn btn-primary w-100">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="row mb-4" id="search-bar">
                <div class="col-md-8 mx-auto">
                    <div class="input-group">
                        <input type="text" class="form-control"
                            id="search-input" placeholder="–ü–æ—à—É–∫ –ø–æ—Å—Ç—ñ–≤...">
                        <button class="btn btn-primary"
                            onclick="searchPosts()">üîç –®—É–∫–∞—Ç–∏</button>
                        <button class="btn btn-outline-secondary"
                            onclick="showPosts()">–°–∫–∏–Ω—É—Ç–∏</button>
                    </div>
                </div>
            </div>

            <!-- Create Post Button -->
            <div class="row mb-3" id="create-post-section"
                style="display:none;">
                <div class="col">
                    <button class="btn btn-success" onclick="showCreatePost()">+
                        –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å—Ç</button>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content"></div>

            <!-- Pagination -->
            <div id="pagination" class="row mt-4">
                <div class="col text-center">
                    <nav>
                        <ul class="pagination justify-content-center"
                            id="pagination-list"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentPage = 1;

        // Check if user is logged in
        if (token) {
            checkAuth();
        }

        async function checkAuth() {
            try {
                const res = await fetch('/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentUser = await res.json();
                    updateAuthUI(true);
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function updateAuthUI(isLoggedIn) {
            document.getElementById('login-btn').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('register-btn').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('user-info').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('create-post-section').style.display = isLoggedIn ? 'block' : 'none';
            if (isLoggedIn && currentUser) {
                document.getElementById('username-display').textContent = `üë§ ${currentUser.username}`;
            }
        }

        function showAuth(type) {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('main-content').innerHTML = '';
            document.getElementById('search-bar').style.display = 'none';
            
            if (type === 'register') {
                document.getElementById('auth-title').textContent = '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è';
                document.getElementById('username-field').style.display = 'block';
                document.getElementById('auth-form').onsubmit = handleRegister;
            } else {
                document.getElementById('auth-title').textContent = '–í—Ö—ñ–¥';
                document.getElementById('username-field').style.display = 'none';
                document.getElementById('auth-form').onsubmit = handleLogin;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };

            try {
                const res = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.');
                    showAuth('login');
                } else {
                    const err = await res.json();
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + (err.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('username', document.getElementById('email').value);
            formData.append('password', document.getElementById('password').value);

            try {
                const res = await fetch('/auth/jwt/login', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    const data = await res.json();
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    await checkAuth();
                    showPosts();
                } else {
                    alert('–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å');
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            updateAuthUI(false);
            showPosts();
        }

        async function showPosts(page = 1) {
            currentPage = page;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('search-bar').style.display = 'block';
            
            try {
                const res = await fetch(`/api/posts?page=${page}&size=10`);
                const data = await res.json();
                
                let html = '<div class="row">';
                for (const post of data.items) {
                    html += `
                        <div class="col-md-6">
                            <div class="card post-card">
                                <div class="card-body">
                                    <h5 class="card-title">${post.title}</h5>
                                    <p class="card-text">${post.content.substring(0, 150)}...</p>
                                    <div class="mb-2">
                                        <small class="text-muted">‚úçÔ∏è ${post.author_name}</small>
                                        ${post.category_name ? `<span class="badge bg-primary ms-2">${post.category_name}</span>` : ''}
                                    </div>
                                    <div class="mb-2">
                                        ${post.tags.map(tag => `<span class="badge bg-secondary tag-badge">#${tag}</span>`).join('')}
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showPost('${post.id}')">–ß–∏—Ç–∞—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                document.getElementById('main-content').innerHTML = html;
                renderPagination(data.page, data.pages, 'showPosts');
            } catch (err) {
                document.getElementById('main-content').innerHTML = '<div class="alert alert-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤</div>';
            }
        }

        async function showPost(id) {
            try {
                const res = await fetch(`/api/posts/${id}`);
                const post = await res.json();
                
                const commentsRes = await fetch(`/api/posts/${id}/comments`);
                const comments = await commentsRes.json();
                
                let html = `
                    <div class="card">
                        <div class="card-body">
                            <h2>${post.title}</h2>
                            <div class="mb-3">
                                <small class="text-muted">‚úçÔ∏è ${post.author_name} | üìÖ ${new Date(post.created_at).toLocaleDateString('uk-UA')}</small>
                                ${post.category_name ? `<span class="badge bg-primary ms-2">${post.category_name}</span>` : ''}
                            </div>
                            <div class="mb-3">
                                ${post.tags.map(tag => `<span class="badge bg-secondary tag-badge">#${tag}</span>`).join('')}
                            </div>
                            <p class="lead">${post.content}</p>
                            <button class="btn btn-secondary" onclick="showPosts()">‚Üê –ù–∞–∑–∞–¥</button>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-body">
                            <h4>üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (${comments.length})</h4>
                            <form onsubmit="addComment(event, '${id}')">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="comment-author" placeholder="–í–∞—à–µ —ñ–º'—è" required>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="comment-content" rows="3" placeholder="–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</button>
                            </form>
                            <div class="mt-4" id="comments-list">
                                ${comments.map(c => `
                                    <div class="comment">
                                        <strong>${c.author}</strong>
                                        <small class="text-muted"> ‚Ä¢ ${new Date(c.created_at).toLocaleDateString('uk-UA')}</small>
                                        <p class="mb-0 mt-2">${c.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
                document.getElementById('pagination').style.display = 'none';
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç–∞');
            }
        }

        async function addComment(e, postId) {
            e.preventDefault();
            const data = {
                author: document.getElementById('comment-author').value,
                content: document.getElementById('comment-content').value
            };

            try {
                const res = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showPost(postId);
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è');
            }
        }

        async function searchPosts() {
            const query = document.getElementById('search-input').value;
            if (!query) return showPosts();
            
            try {
                const res = await fetch(`/api/posts/search/?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                let html = '<div class="row">';
                if (data.items.length === 0) {
                    html += '<div class="col"><div class="alert alert-info">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div></div>';
                } else {
                    for (const post of data.items) {
                        html += `
                            <div class="col-md-6">
                                <div class="card post-card">
                                    <div class="card-body">
                                        <h5 class="card-title">${post.title}</h5>
                                        <p class="card-text">${post.content.substring(0, 150)}...</p>
                                        <button class="btn btn-sm btn-outline-primary" onclick="showPost('${post.id}')">–ß–∏—Ç–∞—Ç–∏</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += '</div>';
                document.getElementById('main-content').innerHTML = html;
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É');
            }
        }

        async function showCategories() {
            document.getElementById('search-bar').style.display = 'none';
            
            try {
                const res = await fetch('/api/categories');
                const categories = await res.json();
                
                let html = '<h2>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h2><div class="row mt-4">';
                for (const cat of categories) {
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${cat.name}</h5>
                                    <p class="card-text">${cat.description}</p>
                                    <button class="btn btn-sm btn-primary" onclick="showCategoryPosts('${cat.id}')">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Å—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                document.getElementById('main-content').innerHTML = html;
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π');
            }
        }

        async function showCategoryPosts(categoryId) {
            try {
                const res = await fetch(`/api/posts/category/${categoryId}`);
                const data = await res.json();
                showPosts();
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó');
            }
        }

        async function showStats() {
            document.getElementById('search-bar').style.display = 'none';
            
            try {
                const [authors, categories, comments, tags] = await Promise.all([
                    fetch('/api/stats/top-authors').then(r => r.json()),
                    fetch('/api/stats/popular-categories').then(r => r.json()),
                    fetch('/api/stats/comments-stats').then(r => r.json()),
                    fetch('/api/stats/tags-distribution').then(r => r.json())
                ]);
                
                let html = `
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="row mt-4">
                        <div class="col-md-4 mb-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3>${comments.total_posts}</h3>
                                    <p>–í—Å—å–æ–≥–æ –ø–æ—Å—Ç—ñ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3>${comments.total_comments}</h3>
                                    <p>–í—Å—å–æ–≥–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3>${comments.average_comments_per_post.toFixed(1)}</h3>
                                    <p>–°–µ—Ä–µ–¥–Ω—å–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>üèÜ –¢–æ–ø –∞–≤—Ç–æ—Ä—ñ–≤</h5>
                                    <ul class="list-group list-group-flush">
                                        ${authors.map(a => `<li class="list-group-item">${a.author} - ${a.post_count} –ø–æ—Å—Ç—ñ–≤</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç–µ–≥–∏</h5>
                                    <div>
                                        ${tags.slice(0, 10).map(t => `<span class="badge bg-secondary m-1" style="font-size: ${12 + t.count}px;">#${t.tag} (${t.count})</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }

        function showCreatePost() {
            document.getElementById('main-content').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –ø–æ—Å—Ç</h3>
                        <form onsubmit="createPost(event)">
                            <div class="mb-3">
                                <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                                <input type="text" class="form-control" id="post-title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ö–æ–Ω—Ç–µ–Ω—Ç</label>
                                <textarea class="form-control" id="post-content" rows="5" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
                                <input type="text" class="form-control" id="post-tags" placeholder="python, web, tutorial">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="post-published">
                                <label class="form-check-label" for="post-published">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</label>
                            </div>
                            <button type="submit" class="btn btn-success">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                            <button type="button" class="btn btn-secondary" onclick="showPosts()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function createPost(e) {
            e.preventDefault();
            const tags = document.getElementById('post-tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            
            const data = {
                title: document.getElementById('post-title').value,
                content: document.getElementById('post-content').value,
                tags: tags,
                published: document.getElementById('post-published').checked
            };

            try {
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('–ü–æ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
                    showPosts();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å—Ç–∞');
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
            }
        }

        function renderPagination(current, total, callback) {
            if (total <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination').style.display = 'block';
            let html = '';
            
            if (current > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="${callback}(${current - 1})">¬´</a></li>`;
            }
            
            for (let i = 1; i <= total; i++) {
                html += `<li class="page-item ${i === current ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="${callback}(${i})">${i}</a>
                </li>`;
            }
            
            if (current < total) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="${callback}(${current + 1})">¬ª</a></li>`;
            }
            
            document.getElementById('pagination-list').innerHTML = html;
        }

        // Initial load
        showPosts();
    </script>
    </body>
</html>